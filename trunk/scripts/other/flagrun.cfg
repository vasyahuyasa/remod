flagkeeper_good_cn = -1
flagkeeper_good_starttime = -1
flagkeeper_good_dropped = 0
flagkeeper_evil_cn = -1
flagkeeper_evil_starttime = -1
flagkeeper_evil_dropped = 0

flagrun_show_messages = 1

// best score time
// flugrun_best_5_reissen = "9602 |RB|degrave"

// flagrun_addresult $run(ms) $name(str)
flagrun_addresult = [
	flagrun_modestring = (concatword "flugrun_best_" (getmode) "_" (getmap))
	flagrun_modescore = (getalias flagrun_modestring)
	// run time not defined
	if (= $flagrun_modescore "") [
		alias $modestring (concat $arg1 $arg2)
	] [
		// if new run time better than prev
		if (< $arg1 (at $flagrun_modescore 0)) [
			alias $modestring (concat $arg1 $arg2) 
			]
	]
]

flagrun_bestresult = [
	flagrun_modestring = (concatword "flugrun_best_" (getmode) "_" (getmap))
	result (getalias $modestring)
]

srv_ontakeflag = [
	//if flag was not dropped earlier (flag was stolen from base)

	team = (getteam $arg1)
	if (=s $team "good") [
		if (!= $flagkeeper_good_dropped 1) [
			flagkeeper_good_cn = $arg1
			flagkeeper_good_starttime = $totalmillis
		]
	] [
		if (!= $flagkeeper_evil_dropped 1) [
			flagkeeper_evil_cn = $arg1
			flagkeeper_evil_starttime = $totalmillis
		]
	]

]

srv_ondropflag = [
	team = (getteam $arg1)
	if (=s $team "good") [
		flagkeeper_good_cn = -1
		flagkeeper_good_starttime = -1
		flagkeeper_good_dropped = 1
	] [
		flagkeeper_evil_cn = -1
		flagkeeper_evil_starttime = -1
		flagkeeper_evil_dropped = 1
	]
]

srv_onscoreflag = [
	team = (getteam $arg1)
	if (=s $team "good") [
		if (&& (!= $flagkeeper_good_cn -1) (= $flagkeeper_good_cn $arg1) (= $flagrun_show_messages 1)) [
			time = (- $totalmillis $flagkeeper_good_starttime)
			pm $arg1 (format "^f1You scored flag for ^f0%1" (millistostr $time 1))
		]
		flagkeeper_good_cn = -1
		flagkeeper_good_starttime = -1
	] [
		if (&& (!= $flagkeeper_evil_cn -1) (= $flagkeeper_evil_cn $arg1)  (= $flagrun_show_messages 1)) [
			time = (- $totalmillis $flagkeeper_evil_starttime)
			pm $arg1 (format "^f1You scored flag for ^f0%1" (millistostr $time 1))
		]
		flagkeeper_evil_cn = -1
		flagkeeper_evil_starttime = -1
	]
	flagkeeper_good_dropped = 0
	flagkeeper_evil_dropped = 0
]

srv_onreturnflag = [
	
	if (= $arg2 2) [
		flagkeeper_good_dropped = 0
	] [
		flagkeeper_evil_dropped = 0
	]

]

srv_onresetflag = [
	if (= $arg1 2) [
		flagkeeper_good_dropped = 0
	] [
		flagkeeper_evil_dropped = 0
	]
]

srv_flag_onmapchange = [
	flagkeeper_good_dropped = 0
	flagkeeper_evil_dropped = 0
]

addhandler ontakeflag srv_ontakeflag
addhandler ondropflag srv_ondropflag
addhandler onscoreflag srv_onscoreflag

addhandler onreturnflag srv_onreturnflag
addhandler onresetflag srv_onresetflag

addhandler onmapchange srv_flag_onmapchange

