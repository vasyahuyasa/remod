//Spy module. Logs ip addresses and names of players.

spy_table = "spy"

defaultvalue "spy_db" "default"

spy_logname = [ 
	db_init $spy_db
	name = $arg2
	ip = (getipint $arg1)
	last_seen = (systimef "%s")
	
	err = (db_insert_replace $spy_table "VALUES (:0, ':1', :2)" (concat $ip $name $last_seen) $spy_db) 
	if (=s $err -1) [
		db_error $spy_db
	]
]
addhandler onconnect [spy_logname $arg1 (getname $arg1)]
addhandler onswitchname spy_logname

//returns player's last connection time and ip. or "" if not found
get_lastseen = [
	db_init $spy_db
	
	query = (format "SELECT ip, lastseen FROM %1 WHERE name=':0' ORDER BY lastseen DESC" $spy_table)
	qh = (db_pquery $query $arg1 $spy_db)
	res = ""
	// check for errors
	if (= $qh -1) [
		db_error $spy_db
	] [
		res = (db_getrow $qh $spy_db)
		a = (db_finalize $qh $spy_db)
	]
	result $res
]

// auto demo record for every next round
cmd_lastseen = [
	res = (get_lastseen $arg2)	
	if (=s $res "") [
		pm $arg1 (format "^f1Player ^f0%1 ^f1have never connected" $arg2)	
	] [
		ip = (ip2str (at $res 0))
		time = (timef (at $res 1) "%d.%m.%Y, %X")
		pm $arg1 (format "^f1Player ^f0%1 ^f1was connected from ip ^f0%3 ^f1at ^f0%2" $arg2 $time $ip)
	]
]
registercommand "lastseen" cmd_lastseen 3 "w" "lastseen (nickname) ^f1Show last time player was connected to the server and player's ip" 

// ban list
irccmd_lastseen = [
	res = (get_lastseen $arg2)	
	if (=s $res "") [
		ircsay (format "^f1Player ^f0%1 ^f1have never connected" $arg2)	
	] [
		ip = (ip2str (at $res 0))
		time = (timef (at $res 1) "%d.%m.%Y, %X")
		ircsay (format "^f1Player ^f0%1 ^f1was connected from ip ^f0%3 ^f1at ^f0%2" $arg2 $time $ip)
	]
]
irc_registercommand "lastseen" irccmd_lastseen 2 "w" "lastseen (nickname). Show last time player was connected to the server and player's ip"
