bestfrag = [
	bfrag = -1;
	bfrager = -1;
	all = (allplayers)
	looplist cn $all [	
		numfrag = (getfrags $cn);
		if (> $numfrag $bfrag) [
			bfrag = $numfrag;
			bfrager = $cn
			];
	]
	res = ""
	looplist cn $all [
		if (= (getfrags $cn) $bfrag) [
			res = (concat $res $cn) 
		];
	]
echo $res
	result $res;
]

bestdeath = [
	bdeath = -1;
	bdeather = -1;
	all = (allplayers)
	looplist cn $all [
		numdeath = (getdeaths $cn)
		if (> $numdeath $bdeath) [
			bdeath = $numdeath;
			bdeather = $cn
			];
	]
	res = ""
	looplist cn $all [
		if (= (getdeaths $cn) $bdeath) [
			res = (concat $res $cn) 
		];
	]
	result $res;
]

bestacc = [
	bacc = -1;
	baccer = -1;
	all = (allplayers)
	looplist cn $all [
		numacc = (getaccuracy $cn);
		if (> $numacc $bacc) [
			bacc = $numacc;
			baccer = $cn
			];
	]
	res = ""
	looplist cn $all [
		if (= (getaccuracy $cn) $bacc) [
			res = (concat $res $cn) 
		];
	]
	result $res;
]

bestkpd = [
	bkpd = -1;
	bkpder = -1;
	all = (allplayers)
	looplist cn $all [
		numkpd = (getkpd $cn);
		if (> $numkpd $bkpd) [
			bkpd = $numkpd;
			bkpder = $cn
			];
	]
	res = ""
	looplist cn $all [
		if (= (getkpd $cn) $bkpd) [
			res = (concat $res $cn) 
		];
	]
	result $res;
]

beststealflag = [
	bstf = -1;
	bstfer = -1;
	all = (allplayers)
	looplist cn $all [
		numstf = (getflags $cn);
		if (> $numstf $bstf) [
			bstf = $numstf;
			bstfer = $cn
		];
	]
	res = ""
	looplist cn $all [
		if (= (getflags $cn) $bstf) [
			res = (concat $res $cn) 
		];
	]
	result $res;
]

//bestreturnflag = [ //unimplemented yet
//	bretf = -1;
//	bretfer = -1;
//	all = (allplayers)
//	looplist cn $all [
//		numretf = (getretflags $cn);
//		if (> $numretf $bretf) [
//			bretf = $numretf
//			bretfer = $cn
//		]
//	]
//	res = ""
//	looplist cn $all [
//		if (= (getflags $cn) $bretf) [
//			res = (concat $res $cn) 
//		];
//	]
//	result $res;
//]

srv_showbest = [
	awdline = "^f3Game awards:";
	
	players = (bestfrag);
	val = (getfrags (at $players 0))
	str = ""
	looplist p $players [
		str = (concat $str (getname $p)) 
	]  
	str = (prettylist $str)
	awdline = (concat $awdline (format "^f1Most frags: ^f0%1 ^f1(^f6%2^f1)" $str $val))
	
	players = (bestdeath);
	val = (getdeaths (at $players 0))
	str = ""
	looplist p $players [
		str = (concat $str (getname $p)) 
	]  
	str = (prettylist $str)
	awdline = (concat $awdline (format "^f1Cannon fodder: ^f0%1 ^f1(^f6%2^f1)" $str $val))
	
	players = (bestacc);
	val = (getaccuracy (at $players 0))
	str = ""
	looplist p $players [
		str = (concat $str (getname $p)) 
	]  
	str = (prettylist $str)
	awdline = (concat $awdline (format "^f1Accuracy: ^f0%1 ^f1(^f6%2%%^f1)" $str $val))
	
	players = (bestkpd);
	val = (getkpd (at $players 0))
	str = ""
	looplist p $players [
		str = (concat $str (getname $p)) 
	]  
	str = (prettylist $str)
	awdline = (concat $awdline (format "^KpD: ^f0%1 ^f1(^f6%2^f1)" $str $val))
	
	if (= (isinlist $FLAGMODES (modetostr (getmode))) 1) [//current gamemode has flags
		//players = (beststealflag);
		//val = (getflags (at $players 0))
		//str = ""
		//looplist p $players [
		//	str = (concat $str (getname $p)) 
		//]  
		//str = (prettylist $str)
		//awdline = (concat $awdline (format "^Flag stealer: ^f0%1 ^f1(^f6%2^f1)" $str $val))


		//players = (bestreturnflag);
		//val = (getretflags (at $players 0))
		//str = ""
		//looplist p $players [
		//	str = (concat $str (getname $p)) 
		//]  
		//str = (prettylist $str)
		//awdline = (concat $awdline (format "^Flag returner: ^f0%1 ^f1(^f6%2^f1)" $str $val))
	]

	say $awdline;
]

irc_showbest = [
	awdline = "GAME ENDED";  
	
	curr_mode = (modetostr (getmode))
	if (= (isinlist $TEAMMODES $curr_mode) 1) [ //if current gamemode is team mode
		awdline = (concat $awdline (format "good: %1 evil: %2" (getteamscores "good") (getteamscores "evil")) 
	]
	
	bfrager = (bestfrag);     
	bfrags = (getfrags $bfrager); 
	if (> $bfrags 40) [ awdline = (concat $awdline (format "Most frags: %1 (%2/%3 %4%%)" (getname $bfrager) $bfrags (getdeaths $bfrager) (getaccuracy $bfrager))) ];
	
	bdeather = (bestdeath);
	bdeaths = (getdeaths $bdeather)
	if (> $bdeaths 30) [ awdline = (concat $awdline (format "Cannon foder: %1 (%2/%3 %4%%)" (getname $bdeather) (getfrags $bdeather) $bdeaths (getaccuracy $bdeather))) ];
	
	baccer = (bestacc); 
	bacc = (getaccuracy $baccer);
	if (> $bacc 30) [ awdline = (concat $awdline (format "Best accuracy: %1 (%2%%)" (getname $baccer) $bacc)) ];
	
	ircsay $awdline;
]

addhandler onimission srv_showbest
addhandler onimission irc_showbest


getplayerstatstr = [ //returns string containing player's statistics
	str = (format "^f1Name: ^f7%1^f1 Frags: ^f7%2^f1 Deathes: ^f7%3^f1 Accuracy: ^f7%4%%^f1 Kpd: ^f7%5^f1%" (getname $arg1) (getfrags $arg1) (getdeaths $arg1) (getaccuracy $arg1) (getkpd $arg1))	
	curr_mode = (modetostr (getmode))

	if (= (isinlist $TEAMMODES $curr_mode) 1) [//current gamemode is team mode
		str = (concatword $str (format " Teamkills: ^f7%1^f1" (getteamkills $arg1)))

		if (= (isinlist $FLAGMODES $curr_mode) 1) [//current gamemode has flags
			//str = (concatword $str (format " Scored flags: ^f7%1^f1" (getflags $arg1) ))  not implemented yet
			//str = (concatword $str (format " Returned flags: %1 " (getretflags $arg1)))  not implemented yet
		]
	]
	str = (concatword $str (format " Rank: ^f7%1^f1" (getrank $arg1)))
	result $str
]

usage_cmd_stats = [result "stats [cn] ^f1Shows game statistics for player cn or for all players if passed -1"]
cmd_stats = [
	if (=s $arg2 "") [ //show stat for current player 
		pm $arg1 (getplayerstatstr $arg1)
	] [
		if (strcmp $arg2 "-1") [ //show statistics for all
			rank = ""
			all = (sortlist (allplayers))
			looplist cn $all [	
				rank = (concat $rank (getrank $cn))
			]

			all = (sorttwolists $rank $all) 
			looplist cn $all [	
				str = (getplayerstatstr $cn)
				if (= $cn $arg1) [str = (concat $str "^f0*")]
				pm $arg1 $str
			]
		] [
			if (= (playerexists $arg2) 0) [ //show statistics for player with cn
				result -1 //wrong cn
			] [
				pm $arg1 (getplayerstatstr $arg2)
			]
		]
	]
]
registercommand "stats" cmd_stats "|i" 1 

